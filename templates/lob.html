{% extends "layout.html" %}

{% block title %}
    Line of Balance
{% endblock %}

{% block main %}
<div>
    <canvas id="lobChart" width="800" height="400"></canvas>
</div>

<script>
    // Fetch the LOB data from the Flask endpoint
    fetch('/lob-data')
        .then(response => response.json())
        .then(data => {
            console.log(data); // This will help you see the fetched data in your browser's console for debugging

            if (data.length === 0) {
                alert("No data available");
                return;
            }

            // Prepare data for Chart.js
            let locations = [];
            let tasks = {};

            data.forEach(row => {
                if (!locations.includes(row.location)) {
                    locations.push(row.location);
                }

                if (!tasks[row.task]) {
                    tasks[row.task] = {
                        label: row.task,
                        data: []
                    };
                }

                tasks[row.task].data.push({
                    x: new Date(row.start_time),
                    y: row.location_order
                });

                tasks[row.task].data.push({
                    x: new Date(row.end_time),
                    y: row.location_order
                });
            });

            let datasets = Object.keys(tasks).map(task => tasks[task]);

            const ctx = document.getElementById('lobChart').getContext('2d');
            const lobChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Location Order'
                            }
                        }
                    },
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        });
</script>
{% endblock %}
